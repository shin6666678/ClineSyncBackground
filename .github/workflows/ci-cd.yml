name: Spring Boot CI/CD to Volcengine Server

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 测试SSH连接（关键：先验证连接）
      - name: Test SSH Connection
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "✅ SSH Connection Success!"
            echo "Server Path: ${{ secrets.SERVER_DEPLOY_PATH }}"
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}/temp
            chmod -R 777 ${{ secrets.SERVER_DEPLOY_PATH }}

      # 用SSH原生命令传输JAR包（替代第三方Action）
      - name: Upload JAR via SSH
        run: |
          # 将私钥写入临时文件
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/id_rsa_github
          chmod 600 /tmp/id_rsa_github
          # 用scp传输（指定私钥文件）
          scp -i /tmp/id_rsa_github -o StrictHostKeyChecking=no target/*.jar ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_DEPLOY_PATH }}/temp/

      # 部署服务
      - name: Deploy Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 停止旧服务
            PID=$(ps -ef | grep 'ClineSyncBackground.jar' | grep -v grep | awk '{print $2}')
            if [ -n "$PID" ]; then kill $PID || true; sleep 3; fi
            # 启动新服务
            mv -f ${{ secrets.SERVER_DEPLOY_PATH }}/temp/*.jar ${{ secrets.SERVER_DEPLOY_PATH }}/ClineSyncBackground.jar
            nohup java -jar ${{ secrets.SERVER_DEPLOY_PATH }}/ClineSyncBackground.jar > ${{ secrets.SERVER_DEPLOY_PATH }}/app.log 2>&1 &
            # 验证
            sleep 5
            if ps -ef | grep 'ClineSyncBackground.jar' | grep -v grep; then
              echo "✅ Service Started!"
            else
              cat ${{ secrets.SERVER_DEPLOY_PATH }}/app.log
              exit 1
            fi