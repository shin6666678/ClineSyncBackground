name: Spring Boot CI/CD to Volcengine Server

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Maven æ‰“åŒ…
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4. æµ‹è¯• SSH è¿æ¥å¹¶å‡†å¤‡ç›®å½•
      - name: Test SSH Connection & Prepare Dir
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… SSH Connection Success!"
            echo "Server Path: ${{ secrets.SERVER_DEPLOY_PATH }}"
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}/temp
            # èµ‹äºˆæƒé™ (è§†æƒ…å†µè€Œå®šï¼Œå¦‚æœæ˜¯ root ç”¨æˆ·å¯èƒ½ä¸éœ€è¦ 777)
            chmod -R 755 ${{ secrets.SERVER_DEPLOY_PATH }}

      # 5. ä¸Šä¼  JAR åŒ… (ä½¿ç”¨åŸç”Ÿ scp)
      - name: Upload JAR via SSH
        run: |
          echo "ğŸ“ Creating temporary SSH key..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/id_rsa_github
          chmod 600 /tmp/id_rsa_github
          
          echo "ğŸš€ Uploading JAR to server..."
          scp -i /tmp/id_rsa_github -o StrictHostKeyChecking=no target/*.jar ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_DEPLOY_PATH }}/temp/
          
          echo "ğŸ§¹ Cleaning up temporary key..."
          rm /tmp/id_rsa_github

      # 6. è¿œç¨‹éƒ¨ç½² (åœæ­¢æ—§æœåŠ¡ -> ç§»åŠ¨æ–°åŒ… -> å¯åŠ¨ -> éªŒè¯)
      - name: Deploy Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # === é…ç½®å˜é‡ ===
            APP_NAME="ClineSyncBackground.jar"
            DEPLOY_PATH="${{ secrets.SERVER_DEPLOY_PATH }}"
            LOG_FILE="$DEPLOY_PATH/app.log"

            echo "ğŸ“‚ Navigate to: $DEPLOY_PATH"
            cd $DEPLOY_PATH

            # === 1. åœæ­¢æ—§æœåŠ¡ (ä¼˜åŒ–ç‰ˆ) ===
            echo "ğŸ›‘ Checking for existing process..."
            PID=$(ps -ef | grep "$APP_NAME" | grep -v grep | awk '{print $2}')
            
            if [ -n "$PID" ]; then
              echo "Process found (PID: $PID). Stopping..."
              kill $PID
            
              # å¾ªç¯ç­‰å¾…è¿›ç¨‹ç»“æŸ (æœ€å¤šç­‰å¾… 20ç§’)
              for i in {1..20}; do
                if ! ps -p $PID > /dev/null; then
                  echo "âœ… Process stopped successfully."
                  break
                fi
                echo "Waiting for process to exit... ($i/20)"
                sleep 1
              done
            
              # å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œå¼ºåˆ¶æ€æ­»
              if ps -p $PID > /dev/null; then
                echo "âš ï¸ Force killing process..."
                kill -9 $PID
              fi
            else
              echo "âœ… No running process found."
            fi

            # === 2. ç§»åŠ¨æ–° JAR åŒ… ===
            echo "ğŸ“¦ Moving new JAR file..."
            # å¼ºåˆ¶è¦†ç›–æ—§æ–‡ä»¶
            if ls $DEPLOY_PATH/temp/*.jar 1> /dev/null 2>&1; then
                mv -f $DEPLOY_PATH/temp/*.jar $DEPLOY_PATH/$APP_NAME
            else
                echo "âŒ Error: No JAR file found in temp directory!"
                exit 1
            fi

            # === 3. å¯åŠ¨æ–°æœåŠ¡ ===
            echo "ğŸš€ Starting new application..."
            # ä½¿ç”¨ nohup åå°å¯åŠ¨
            nohup java -jar $DEPLOY_PATH/$APP_NAME > $LOG_FILE 2>&1 &

            # === 4. å¥åº·æ£€æŸ¥ ===
            echo "ğŸ¥ Health checking..."
            sleep 10  # ç­‰å¾… Spring Boot åˆå§‹åŒ–
            
            NEW_PID=$(ps -ef | grep "$APP_NAME" | grep -v grep | awk '{print $2}')
            
            if [ -n "$NEW_PID" ]; then
              echo "âœ… Deployment Successful! Process ID: $NEW_PID"
              echo "ğŸ“‹ Tail of the log:"
              tail -n 20 $LOG_FILE
            else
              echo "âŒ Deployment Failed! Process not running."
              echo "ğŸ“‹ Full log content:"
              cat $LOG_FILE
              exit 1
            fi