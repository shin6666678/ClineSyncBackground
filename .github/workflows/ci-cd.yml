name: Spring Boot CI/CD to Volcengine Server

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 设置超时时间，避免无限等待

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests
        # 捕获构建失败，避免后续步骤无效执行
        continue-on-error: false

      # 第一步：先在服务器创建目录（避免上传时目录不存在）
      - name: Prepare Server Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}/temp
            # 确保目录权限足够
            chmod -R 755 ${{ secrets.SERVER_DEPLOY_PATH }}

      # 第二步：上传JAR包（改用更稳定的rsync）
      - name: Upload JAR to Server
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avz --progress  # 显示传输进度
          path: target/*.jar
          remote_path: ${{ secrets.SERVER_DEPLOY_PATH }}/temp/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USERNAME }}
          remote_port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 第三步：部署并启动服务
      - name: Deploy and Start Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 停止旧服务（优雅停止，避免强制kill）
            PID=$(ps -ef | grep 'ClineSyncBackground.jar' | grep -v grep | awk '{print $2}')
            if [ -n "$PID" ]; then
              kill $PID || true  # 允许kill失败（比如进程已退出）
              sleep 3  # 等待进程退出
            fi
            # 移动JAR包（覆盖旧包）
            mv -f ${{ secrets.SERVER_DEPLOY_PATH }}/temp/*.jar ${{ secrets.SERVER_DEPLOY_PATH }}/ClineSyncBackground.jar
            # 启动新服务（指定JVM参数，优化性能）
            nohup java -Xms512m -Xmx1024m -jar ${{ secrets.SERVER_DEPLOY_PATH }}/ClineSyncBackground.jar > ${{ secrets.SERVER_DEPLOY_PATH }}/app.log 2>&1 &
            # 清理临时目录
            rm -rf ${{ secrets.SERVER_DEPLOY_PATH }}/temp
            # 验证服务是否启动
            sleep 5
            if ps -ef | grep 'ClineSyncBackground.jar' | grep -v grep; then
              echo "Service started successfully!"
            else
              echo "Service start failed! Check logs:"
              cat ${{ secrets.SERVER_DEPLOY_PATH }}/app.log
              exit 1  # 标记部署失败
            fi