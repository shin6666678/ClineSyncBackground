name: Spring Boot CI/CD to Volcengine Server

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Maven æ‰“åŒ…å¹¶è·å– JAR æ–‡ä»¶å
      - name: Build with Maven
        run: |
          mvn clean package -DskipTests
          # æŸ¥æ‰¾ç”Ÿæˆçš„ JAR æ–‡ä»¶åï¼Œå¹¶ä¿å­˜ä¸ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          JAR_FILE=$(ls -t target/*.jar | grep -v 'original' | head -n 1)
          echo "APP_JAR_FILE=$JAR_FILE" >> $GITHUB_ENV

      # 4. æµ‹è¯• SSH è¿æ¥å¹¶å‡†å¤‡ç›®å½•
      - name: Test SSH Connection & Prepare Dir
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… SSH Connection Success!"
            echo "Server Path: ${{ secrets.SERVER_DEPLOY_PATH }}"
            # ç¡®ä¿ä¸Šä¼ ä¸´æ—¶ç›®å½•å­˜åœ¨
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}/temp
            # èµ‹äºˆæƒé™
            chmod -R 755 ${{ secrets.SERVER_DEPLOY_PATH }}

      # 5. â­ï¸ æ€§èƒ½ä¼˜åŒ–ï¼šå‹ç¼©å’Œä¸Šä¼ å½’æ¡£æ–‡ä»¶ (è§£å†³ä¸Šä¼ æ…¢çš„é—®é¢˜)
      - name: Compress and Upload Archive via SSH
        run: |
          ARCHIVE_NAME="app.tar.gz"
          
          echo "ğŸ“¦ Compressing JAR file: ${{ env.APP_JAR_FILE }} into $ARCHIVE_NAME"
          # ä½¿ç”¨ tar -czf å°† JAR åŒ…å‹ç¼©æˆ app.tar.gz
          tar -czf $ARCHIVE_NAME ${{ env.APP_JAR_FILE }}
          
          echo "ğŸ“ Creating temporary SSH key..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/id_rsa_github
          chmod 600 /tmp/id_rsa_github
          
          echo "ğŸš€ Uploading compressed archive ($ARCHIVE_NAME) to server..."
          # ä¸Šä¼ å‹ç¼©åŒ…
          scp -i /tmp/id_rsa_github -o StrictHostKeyChecking=no $ARCHIVE_NAME ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_DEPLOY_PATH }}/temp/
          
          echo "ğŸ§¹ Cleaning up temporary key..."
          rm /tmp/id_rsa_github

      # 6. è¿œç¨‹éƒ¨ç½² (è§£å‹ -> åœæ­¢æ—§æœåŠ¡ -> å¯åŠ¨æ–°æœåŠ¡)
      - name: Deploy Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # === é…ç½®å˜é‡ ===
            FINAL_APP_NAME="ClineSyncBackground.jar" # è¿œç¨‹æœåŠ¡å™¨ä¸Šæœ€ç»ˆè¿è¡Œçš„æ–‡ä»¶å
            DEPLOY_PATH="${{ secrets.SERVER_DEPLOY_PATH }}"
            LOG_FILE="$DEPLOY_PATH/app.log"
            TEMP_ARCHIVE="$DEPLOY_PATH/temp/app.tar.gz"

            echo "ğŸ“‚ Navigate to: $DEPLOY_PATH"
            cd $DEPLOY_PATH

            # === 1. è§£å‹å’Œæ›¿æ¢æ–‡ä»¶ ===
            echo "ğŸ“¦ Unpacking and replacing files..."
            if [ -f "$TEMP_ARCHIVE" ]; then
              # è§£å‹æ–‡ä»¶åˆ°å½“å‰ç›®å½• (ä¼šåˆ›å»º target/ ç›®å½•)
              tar -xzf $TEMP_ARCHIVE -C ./
            
              # æ‰¾åˆ°è§£å‹å‡ºçš„æ–° JAR åŒ…å (é€šå¸¸åœ¨ target/ ç›®å½•ä¸‹)
              NEW_JAR_NAME=$(ls -t target/*.jar | grep -v 'original' | head -n 1)
            
              # é‡å‘½åä¸ºæœ€ç»ˆçš„æœåŠ¡å
              mv -f "$NEW_JAR_NAME" "$DEPLOY_PATH/$FINAL_APP_NAME"
            
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
              rm -f $TEMP_ARCHIVE
              rm -rf target/ # æ¸…ç†è§£å‹åäº§ç”Ÿçš„ target ç›®å½•
            else
              echo "âŒ Error: Compressed archive not found in temp directory!"
              exit 1
            fi

            # === 2. åœæ­¢æ—§æœåŠ¡ (ç¨³å¥æ£€æŸ¥) ===
            echo "ğŸ›‘ Checking for existing process..."
            PID=$(ps -ef | grep "$FINAL_APP_NAME" | grep -v grep | awk '{print $2}')
            
            if [ -n "$PID" ]; then
              echo "Process found (PID: $PID). Stopping..."
              kill $PID
            
              # å¾ªç¯ç­‰å¾…è¿›ç¨‹ç»“æŸ (æœ€å¤šç­‰å¾… 20ç§’)
              for i in {1..20}; do
                if ! ps -p $PID > /dev/null; then
                  echo "âœ… Process stopped successfully."
                  break
                fi
                echo "Waiting for process to exit... ($i/20)"
                sleep 1
              done
            
              # å¦‚æœ 20 ç§’åè¿˜åœ¨è¿è¡Œï¼Œå¼ºåˆ¶æ€æ­»
              if ps -p $PID > /dev/null; then
                echo "âš ï¸ Force killing process..."
                kill -9 $PID
              fi
            else
              echo "âœ… No running process found."
            fi

            # === 3. å¯åŠ¨æ–°æœåŠ¡ ===
            echo "ğŸš€ Starting new application..."
            # ä½¿ç”¨ nohup åå°å¯åŠ¨
            nohup java -jar $DEPLOY_PATH/$FINAL_APP_NAME > $LOG_FILE 2>&1 &

            # === 4. å¥åº·æ£€æŸ¥ ===
            echo "ğŸ¥ Health checking..."
            sleep 10  # ç­‰å¾… Spring Boot åˆå§‹åŒ–
            
            NEW_PID=$(ps -ef | grep "$FINAL_APP_NAME" | grep -v grep | awk '{print $2}')
            
            if [ -n "$NEW_PID" ]; then
              echo "âœ… Deployment Successful! Process ID: $NEW_PID"
              echo "ğŸ“‹ Tail of the log:"
              tail -n 20 $LOG_FILE
            else
              echo "âŒ Deployment Failed! Process not running."
              echo "ğŸ“‹ Full log content:"
              cat $LOG_FILE
              exit 1
            fi